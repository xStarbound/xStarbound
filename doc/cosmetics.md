# Armour/cosmetic item instance values

The following non-vanilla armour/cosmetic item instance values are supported by xStarbound. All are quietly ignored without errors by clients that don't support them, and in all cases, values of the wrong type are quietly ignored, ensuring full backwards compatibility with stock Starbound. Except as noted below, only the _viewer_ needs xClient to see the effects of the parameters below — the wearer can use any other client, which can come in handy for certain cases!

- **`humanoidConfig`:** _[xClient and OpenStarbound.]_ Optional JSON object (key-value map) that contains (mostly) cosmetic humanoid config overrides. For the most part, overrides specified in this object are identical to those specified in `$assets/humanoid.config` and in `"humanoidOverrides"` in your species or image path's `.species` file, but some bear special mention. Aside from a few exceptions mentioned below, a normal non-nulling JSON merge is performed to merge the overrides into the base humanoid configuration for the player or NPC's species or image path. _[Also supported by OpenStarbound.]_

  - **`"movementParameters"`:** If `"movementParameters"` overrides are present, these overrides, while having non-cosmetic in-game effects, are respected and applied by xStarbound and OpenStarbound, but are overridden by Lua scripts that modify or control movement parameters. Movement parameter overrides also show up in `mcontroller.parameters` (added to actor movement controller bindings on both xStarbound and OpenStarbound). Like other `"humanoidConfig"` overrides, overridden movement parameters are only applied if the armour item is not visually hidden.
  - **`"identity"`:** _[xClient only, but renders on all clients if the wearer is on xClient using `"broadcast"`.]_ Optional humanoid identity overrides. All five exceptions to the JSON merge rule exist here: The `"bodyDirectives"`, `"emoteDirectives"`, `"hairDirectives"`, `"facialHairDirectives"` and `"facialMaskDirectives"` keys (or «slots»). Any directive «slot» whose string contains any `<base>` tags undergoes special cumulative tag merging as described under `<base>`'s entry in _Cosmetic replacement tags_ below. There is one new optional `"identity"` key — `"broadcast"`. If this is set to `true` after all merges, the identity overrides are «broadcast» in a way that makes them visible to _all_ clients, including stock clients; otherwise, only xClient clients and xServer servers can see the overrides. Overrides affect the result of `world.entityPortrait` on clients and servers that are allowed to see them, and are always visible in team bar portraits due to how they're networked. Any `"gender"` overrides also affect which gender's armour sprites are used on clients that are allowed to see them.

    _Tip:_ If using xStarbound's `"nudehuman"` and `"undyhuman"` image paths, consider leaving `"broadcast"` off to avoid having an invisible body (and logging errors) on non-xClient clients (and consider avoiding team invites to avoid harmless, but annoying logged errors from your networked portrait).

- **`"flipDirectives"`:** Optional string that contains directives to be applied when the player or NPC is facing left. If the string begins with a `+`, the `+` is expanded into whatever is in the `"directives"`. These directives are only visible on xStarbound and OpenStarbound.
- **`"xSBdirectives"`:** _[Requires the wearer to use xClient v4.1.2+, but renders on all clients.]_ Optional string. Like `"directives"`, but supports substitution tags; see _Cosmetic substitution tags_ below. If this value contains a string, the resulting post-substitution directives will be networked (and rendered) in place of the standard `"directives"` (unless the player is facing left and there are `"xSBflipDirectives"`), allowing _all_ clients (including stock clients!) to see the item's appearance when you're wearing it.
- **`"xSBflipDirectives"`:** _[Requires the wearer to use xClient v4.1.2+, but renders on all clients.]_ Optional string. Like `"flipDirectives"`, but supports substitution tags; see _Cosmetic substitution tags_ below. If this value contains a string, the resulting post-substitution directives will be networked (and rendered) in place of the standard `"directives"` when the player is facing to the left, allowing _all_ clients (including stock clients!) to see the item's flipped appearance when you're wearing it.
- **`"stackedItems"`:** _[xClient only, but renders with caveats on OpenStarbound clients.]_ Optional array of versioned item descriptors that store overlays on this armour/cosmetic item.

  To stack items on xClient, click the item you wish to use as an overlay to put it in in the swap slot, and then **<kbd>Shift</kbd> + <kbd>Right Click</kbd>** the base item you wish to overlay it onto (which must be of the same armour type, but valid items will show a small, red `+` indicator), which may already have overlays on it, and the item will disappear from the swap slot and be overlaid onto the base item. The process may be further repeated with other armour/cosmetic items you want to use as overlays, as many times as you wish.

  To remove the topmost overlay from an overlaid base item, **<kbd>Shift</kbd> + <kbd>Right Click</kbd>** the stacked base item with an empty swap slot and the topmost overlay will be removed and appear in the swap slot. To remove further overlays, put the previously overlaid item aside somewhere in your inventory or a container and repeat the process.

  Stacks of up to 99 overlays are supported[^3], and overlaid items show a stack count that includes the base item in the count (e.g., an item with three overlays has a count of `4`). Stackable cosmetic items (with a `"maxStack"` instance value or config parameter other than `1`) cannot have overlays inserted onto them via the UI, because otherwise the overlay stack count wouldn't be visible.

  Overlaid items that do not match this (base) item's armour type (any of head, chest, legs or back) are quietly ignored by xClient (and can still be unstacked with a **<kbd>Shift</kbd> + <kbd>Right Click</kbd>** if, for some reason, you stuck an «incompatible» item in here), although errors in overlay item instantiation will convert the overlaid item into a Perfectly Generic Item (with all item data saved in it) upon any attempt to unstack it. Up to twelve visible xStarbound overlays are networked to OpenStarbound clients, with certain other caveats mentioned below.

- **`"underlaid"`:** _[xClient only.]_ Optional boolean. If `true` and this item is in an armour (not cosmetic) slot, this item and any overlays on it are visibly underlaid behind any item in the corresponding cosmetic slot, as long as the wearer isn't wearing any item in the stock cosmetic slots with this item's slot type «blacklisted» in its `"armorTypesToHide"` parameter.
- **`"armorTypesToHide"`:** _[xClient and OpenStarbound.]_ Optional array of armour type strings; valid strings are `"head"`, `"chest"`, `"legs"` and `"back"`. If this armour item is in a cosmetic slot (whether stock or OpenStarbound), is not an overlay, (for an xClient wearer) is _not_ hidden via `"hideInVanillaSlots"`, and (for an OpenStarbound wearer) is _not_ hidden via the slot's toggle setting saved in the player file (both of which are toggled via a middle-click on their respective clients), it visually hides any items in the armour (not cosmetic) slots of the specified types when worn.
- **`"hideInVanillaSlots"`:** _[xClient and OpenStarbound.]_ Optional boolean. If `true`, this armour item is visually hidden and all humanoid and identity overrides it has on it are disabled. For non-overlay items in the stock armour and cosmetic slots, items hidden this way are broadcast by an xStarbound client as empty slots, so the item and its effects appear hidden on _all_ clients, even stock clients. This includes `"broadcast"` humanoid identity overrides on the item! Toggled by middle-clicking on the item on xClient. Intentionally ignored in OpenStarbound cosmetic slots by xClient for visual parity with OpenStarbound.
- **`"bypassNude"`:** [xClient and OpenStarbound.] Optional boolean. If `true`, this item is visible even when the player is nude (i.e., has the `"nude"` status effect or status modifier). Doesn't do anything on overlays themselves, but if overlaid on an item with `"bypassEnabled"`, the overlay is also visible while nude (if it's not hidden, of course). Useful for underwear! Doesn't get networked to stock clients though.
- **`"hideBody"`:** _[xClient and OpenStarbound. xClient wearers network to all clients.]_ Optional boolean. Toggles whether the base humanoid body is invisible when this item is worn and not visually hidden. Works on xStarbound overlays and OpenStarbound cosmetic slots. On stock clients, this setting can only be changed in the item's asset file (i.e., its `.head`, `.chest`, `.legs` or `.back` file) and the _viewing_ client's setting is what's used. On OpenStarbound and xClient, this setting is supported as an instance value, and xClient v4.1.2+, the wearer's body is hidden for _all_ viewing clients if `"hideBody"` is enabled, regardless of its asset setting, but the setting can't be disabled on an item whose asset config has it enabled this way.
- **`"gender"`:** _[xClient only.]_ Optional string. If `"male"` or `"female"`, xClient displays that gender's sprites regardless of the player or NPC's gender; if unspecified or any other value, it does nothing and the vanilla behaviour is used. Note that without this setting, xClient always uses the armour sprites for the gender in the player or NPC's identity after overrides. Unfortunately visible only on other xClient v4.1.2+ clients, but hey, this is what directive sprites are for!

[^3] Technically, the supported overlay stack size is unlimited, but xClient's UI caps it at 99.

> **Image paths:** If the player or NPC has an `"imagePath"` specified in its base `"identity"`, any `"humanoidOverrides"` found in any associated `.species` file for the image path are prioritised over those for the player or NPC's base species. Any `"species"` or `"imagePath"` specified in an armour item's `"identity"` overrides are prioritised over base species / image path overrides, and humanoid overrides specified in the armour item's instance parameters override everything else. Note that `"movementParameters"` overrides, while having non-cosmetic in-game effects, are respected and applied by xStarbound, but are overridden by Lua scripts that modify or control movement parameters.

The following vanilla armour/cosmetic item instance values have had their behaviour changed by xStarbound. All changes are fully backwards-compatible with stock Starbound and OpenStarbound unless otherwise stated.

- **`"directives"`:** If this parameter's value begins with a `??` (two question marks), the item's armour directives are not applied to its inventory icon.
- **`"inventoryIcon"`:** Directives on image paths specified in this parameter are no longer stripped by xClient, but are stripped by vanilla clients. Backwards-compatible because nobody was putting directives in here anyway.
- **`"colorOptions"`:** Because of xClient's change to `"directives"`, directive string entries in this parameter are now required to begin with a `?` (question mark) on xClient, a minor compatibility break from stock and OpenStarbound. Hardly matters because nobody was putting directive strings in here anyway.

## Cosmetic substitution tags

xStarbound supports the following substitution tags in `"xSBdirectives"`, `"xSBflipDirectives"` and `"humanoidConfig"` → `"identity"` overrides. Their return values default to empty strings unless otherwise specified.

- **`<base>`:** For `"xSBdirectives"` and `"xSBflipDirectives"`, returns the item's base `"directives"` or `"flipDirectives"`, respectively; the returned `"flipDirectives"` do _not_ include any initial `+` or the right-facing directives it expands to (so use `+<base>` or `<right><base>` in your `"xSBflipDirectives"`).

  For identity directives, the current cumulative directives already in the identity «slot» being overridden by these directives (one of `"bodyDirectives"`, `"emoteDirectives"`, `"hairDirectives"`, `"facialHairDirectives"` and `"facialMaskDirectives"`); if `<base>` isn't present, the item will completely replace the cumulative (or base) directives in this «slot» when visited. Before any overrides are processed in a given «slot», `<base>` is equivalent to the player or NPC's base identity directives in this «slot». Processed before any other tag except `<right>`.

- **`<right>`:** _[Only available in `"xSBflipDirectives"`.]_ Returns the right-facing `"directives"` or, if present, `"xSBdirectives"`. Processed before any other tag, so that tags in the returned `"xSBdirectives"` get processed. Note that any `<base>` tags inside directives returned by `<right>` tags return the `"directives"`, not `"flipDirectives"`. Outside of directives returned by `<right>` tags, `<base>` returns `"flipDirectives"` (without any `+` or the directives it expands to). If a `+` prefix is present, `<right>` cannot be used. `+` is identical in effect to `<right>` at the beginning of the directive string.
- **`<species>`:** The player or NPC's species name. Defaults to `human` internally if unspecified in the base identity.
- **`<imagePath>`:** The player or NPC's image path, used for humanoid rendering if present. If no image path is present, defaults to the player or NPC's species, and if that isn't present, defaults to `human` internally.
- **`<gender>`:** The player or NPC's gender, either `male` or `female`. Defaults to `male` internally if unspecified in the base identity.
- **`<bodyDirectives>`:** The player or NPC's body directives. These apply to the body (including the head and arms), but not to hair, emotes, facial hair or facial masks.
- **`<emoteDirectives>`:** The player or NPC's emote directives. Defaults to the player or NPC's body directives internally if unspecified in the base identity.
- **`<hairGroup>`:** The player or NPC's hair group. Defaults to `hair` internally if unspecified in the base identity. _Vanilla:_ This is `hairmale` or `hairfemale` for Apex and `hair` for all other vanilla species and image paths.
- **`<hairType>`:** The player or NPC's hair type. Defaults to `male1` internally if unspecified in the base identity. _Vanilla:_ Begins with `male` or `fem` for Humans and Novakids, is always `male1` for Fenerox and Shadow, and is always `male0` for Penguins. For all other species and image paths, it's just a number.
- **`<hairDirectives>`:** The player or NPC's hair directives. These don't apply to facial hair. Although head armour/cosmetic masks apply to these directives, the return value does not include any mask directives from head armour/cosmetic items.
- **`<facialHairGroup>`:** The player or NPC's facial hair group. _Vanilla:_ Is `beardmale` or `beardfemale` for Apex, `fluff` for Avians, `brand` for Novakids, and an empty string for all other vanilla species and image paths.
- **`<facialHairType>`:** The player or NPC's facial hair type. _Vanilla:_ Is a number for those species that have facial hair.
- **`<facialHairDirectives>`:** The player or NPC's facial hair directives. These don't apply to regular hair. Although head armour/cosmetic masks apply to these directives, the return value does not include any mask directives from head armour/cosmetic items.
- **`<facialMaskGroup>`:** The player or NPC's facial mask group. _Vanilla:_ Is `beaks` for Avians and an empty string for all other vanilla species and image paths.
- **`<facialMaskType>`:** The player or NPC's facial mask group. _Vanilla:_ Is a number for Avians.
- **`<facialMaskDirectives>`:** The player or NPC's facial mask directives. Although head armour/cosmetic masks apply to these directives, the return value does not include any mask directives from head armour/cosmetic items.
- **`<personalityIdle>`:** The player or NPC's idle body personality. Defaults to `idle.1` internally.
- **`<personalityArmIdle>`:** The player or NPC's idle arm personality. Defaults to `idle.1` internally.
- **`<headOffsetX>` and `<headOffsetY>`:** The X and Y values for the player or NPC's idle head offset, respectively. Both default to `0.0` internally.
- **`<armOffsetX>` and `<armOffsetY>`:** The X and Y values for the player or NPC's idle arm offset, respectively. Both default to `0.0` internally.
- **`<color>`:** The player or NPC's favourite colour. Defaults to `ffffffff` (i.e., fully opaque white) internally. _Vanilla:_ The default favourite colour defined in the vanilla `$assets/player.config` is `3375edff` (a light blueish colour, `51, 117, 237, 255` in decimal).

## Notes

**Merge visitation order:** When merging humanoid overrides, xClient visits armour slots in the following order: **Head Cosmetic → Head Armour → Chest Cosmetic → Chest Armour → Legs Cosmetic → Legs Armour → Back Cosmetic → Back Armour**. Overrides present on visible xStarbound overlays (i.e., with `"hideInVanillaSlots"` disabled) are visited just after their base item in back-to-front order.

**Layering order:** When rendering humanoids and armour underlays and overlays, the following rendering order applies, from back to front:

1. Back armour → back armour overlays (back to front) → back cosmetic → back cosmetic overlays (back to front).
2. Back arm. `"bodyDirectives"` are applied, then arm frame override directives (split from the frame override itself) are applied. If the arm frame override directives begin with `??` (two question marks), the vanilla behaviour — arm frame override directives _before_ `"bodyDirectives"` — is restored.[^2]
3. Chest armour back sleeves → chest armour overlay back sleeves (back to front) → chest cosmetic back sleeves → chest cosmetic overlay back sleeves (back to front).
4. OpenStarbound chest cosmetic back sleeves, in numerical slot order from lowest to highest (left to right, bottom to top on OpenStarbound's inventory screen[^1]).
5. Head. `"bodyDirectives"` are applied.
6. Emotes. `"emoteDirectives"`, if they exist in the identity after all overrides are accounted for, are applied to the emotes; otherwise `"bodyDirectives"` are applied. _Not_ masked by armour/cosmetics, but you can apply an `?addmask` directive to the `"emoteDirectives"` after `<base>` in the armour item's humanoid identity overrides to work around this.
7. Hair (including mask directives from head armour/cosmetics, in back-to-front order, _after_ the identity directives).
8. Body. `"bodyDirectives"` are applied.
9. Legs armour.
10. Chest and legs cosmetics (not including their sleeves) in the first four OpenStarbound chest slots, in numerical slot order from lowest to highest (bottom row, left to right on OpenStarbound's inventory screen[^1]).
11. Chest armour (not sleeves).
12. Legs and chest armour overlays (not including their sleeves) in staggered order (**LEGS → CHEST → LEGS → CHEST → LEGS → CHEST → ...**); visually hidden overlays (with `"hideInVanillaSlots"` enabled) count as empty slots for staggering.
13. Legs cosmetic → chest cosmetic (not sleeves).
14. Legs and chest cosmetic overlays (not including their sleeves) in staggered order (**LEGS → CHEST → LEGS → CHEST → LEGS → CHEST → ...**); visually hidden overlays (with `"hideInVanillaSlots"` enabled) count as empty slots for staggering.
15. Chest and legs cosmetics (not including their sleeves) in the last eight OpenStarbound chest slots, in numerical slot order from lowest to highest (middle and top rows, left to right, middle to top on OpenStarbound's inventory screen[^1]).
16. Facial hair (including mask directives from head armour/cosmetics, in back-to-front order, _after_ the identity directives). `"facialHairDirectives"` are applied. In vanilla Starbound, this includes Apex facial hair / beards, Novakid brands and Avian fluff.
17. Facial masks (including mask directives from head armour/cosmetics, in back-to-front order, _after_ the identity directives). `"facialMaskdirectives"` are applied. In vanilla Starbound, Avian beaks are facial masks.
18. Head armour → head armour overlays (back to front) → head cosmetic → head cosmetic overlays (back to front). For each head item in the «stack», mask directives from all head items _above_ that item are applied to the head item in back-to-front order, _after_ the item's own directives. The topmost item obviously has no mask directives applied to it.
19. OpenStarbound head cosmetics, in numerical slot order from lowest to highest (left to right, bottom to top on OpenStarbound's inventory screen[^1]). Mask directives from these items are applied to the hair, facial hair and facial mask in back-to-front order after all other head items' mask directives, but are intentionally _not_ applied to _any_ head items (including OpenStarbound cosmetics) to emulate OpenStarbound's behaviour in this regard for exact appearance matches.
20. Front arm. `"bodyDirectives"` are applied, then arm frame override directives (split from the frame override itself) are applied. If the arm frame override directives begin with `??` (two question marks), the vanilla behaviour — arm frame override directives _before_ `"bodyDirectives"` — is restored.[^2]
21. Chest armour front sleeves → chest armour overlay front sleeves (back to front) → chest cosmetic front sleeves → chest cosmetic overlay front sleeves (back to front).
22. OpenStarbound chest cosmetic front sleeves, in numerical slot order from lowest to highest (left to right, bottom to top on OpenStarbound's inventory screen[^1]).

[^1]: Assuming no mods that alter the layout of the cosmetic slots. When in doubt, use the slot numbers in the tooltips.

[^2]: This is an intentional deviation from vanilla behaviour on both OpenStarbound and xStarbound, to prevent certain items from rendering big ugly squares caused by their `?crop` directives used to visually shift the sprite (or whatever else) being applied _before_ bodyDirectives (which may include a custom body sprite which depends on there not being weird `?crop` directives before it to be rendered properly). The `??` override to disable this behaviour is ignored by OpenStarbound.

> _Note on staggering:_ When staggering chest and legs overlays, if the number of chest overlays in a given layer ordering «slot» above does not match the number of legs overlays in the same slot, the remainder from the larger set of overlays is rendered back to front after the first N overlays, where N is the smaller number. Some examples:
>
> - **LEGS → CHEST → LEGS → LEGS → LEGS:** One chest overlay and four legs overlays.
> - **LEGS → CHEST → LEGS → CHEST → CHEST → CHEST:** Two legs items and four chest overlays.
> - **CHEST → CHEST:** Zero legs overlays and two chest overlays.
>
> xClient staggers items in the emulated OpenStarbound cosmetic slots when networking to OpenStarbound in the order used above.

**OpenStarbound cosmetics emulation:** xClient emulates OpenStarbound's cosmetics system. See below.

_OpenStarbound-to-xStarbound:_ xClient renders OpenStarbound cosmetics _exactly_ as they are rendered on OpenStarbound, aside from human underwear if `"removeHumanUndies"` is disabled (or unspecified) in `xclient.config`. That is, barring some xStarbound-only parameters — humanoid `"identity"` overrides, in the instance parameters of items in _all_ OpenStarbound armour slots, and overlays and underlay statuses on items in the stock armour/cosmetic slots, _are_ rendered on xClient clients, including tag substitutions (but not the `"broadcast"` parameter, for obvious reasons). This can be used to «forcibly» remove the underwear on your OpenStarbound human character with a special armour-slot item that has the parameters `"underlaid": true` and `"humanoidConfig": { "identity": { "imagePath": "nudehuman" } }`.

_xClient-to-OpenStarbound:_ xClient networks up to twelve of its own cosmetic overlays to OpenStarbound clients with some caveats, namely that overlays on underlaid items are not networked and any non-hidden overlays on an item in an armour slot hide the base item on OpenStarbound clients.

Additionally there's a visual layering quirk on OpenStarbound's end that xClient tries its best to work around — chest and legs items in the first four OpenStarbound cosmetic slots (the four to the right of the vanilla legs slots) are always layered _below_ any visible armour/cosmetic item in the vanilla chest slots, xStarbound v4.1.2+ prioritises chests and legs items, and starts at the fifth OpenStarbound cosmetic slot, wrapping around to the first four slots when it reaches the twelfth slot, in order to reduce the chance of legs overlays being shown as layered under chest items.

Unfortunately, that means that any chest and legs overlays among the 9th to 12th visited xStarbound overlays will be layered under any chest items in the vanilla slots, so this workaround only «protects» the visual ordering of the first eight visited xStarbound overlays from being visually «mangled» by OpenStarbound clients. As such, you should ensure you have fewer than eight visible chest and legs overlays (including empty «filler» overlays) in total.

As such, when tallying up overlays to network to OpenStarbound, the visitation order is: **Staggered Chest and Legs Cosmetics/Armour → Back Cosmetic/Armour → Head Cosmetic/Armour**. Overlays stacked on base items that are hidden by `"hideInVanillaSlots"`, disabled underlay status or any cosmetic item's `"armourTypesToHide"` value are not visited for OpenStarbound networking purposes, but hidden _overlays_ (those with `"hideInVanillaSlots"` enabled) _are_ visited (leaving corresponding empty OpenStarbound slots) as long as the base item isn't hidden. This allows hidden chest/legs overlays used to «fill» a chest/legs stagger slot to work properly when networked to OpenStarbound.

**Visual hiddenness:** A «visually hidden» item is one for which at least _one_ of the following criteria apply:

- This item is in an armour (not cosmetic) slot, has underlay visibility _disabled_ (i.e., `"underlaid"` is `false` or not present, and the underlay border isn't present), and the player/NPC is wearing an item in the corresponding cosmetic slot.
- This item is in an armour (not cosmetic) slot, and the player/NPC is wearing another item in a cosmetic slot whose `"armourTypeToHides"` value includes the armour slot for this item.
- This item has `"hideInVanillaSlots"` enabled and is not in an OpenStarbound cosmetic slot.
- This item is acting as an xStarbound overlay on any other armour/cosmetic to which at least _one_ of the other three criteria apply.
- The player or NPC is nude (i.e., has the `"nude"` status modifier) and the item is either a non-overlay that does not have `"bypassNude"` enabled or an overlay whose base item does not have `"bypassNude"` enabled.

Note that for OpenStarbound clients viewing players mastered by an xClient client, the criteria for «visually hidden» include all of the above, plus the following:

- This item is in an armour (not cosmetic) slot and an item is also worn in the corresponding cosmetic slot. This applies _regardless_ of xStarbound's underlay status.
- This item is a cosmetic overlay, the player is wearing more than 12 total overlays on items in the armour or cosmetic slots (_not_ counting overlays on items in a given armour slot if the player/NPC is wearing an item _not_ hidden because of `"hideinVanillaSlots"` status in the corresponding cosmetic slot), and this overlay happens to be number 13 or higher in xClient's visitation order (see above).
- This item is in an armour (not cosmetic) slot, there is no item worn in the corresponding cosmetic slot, and this item has any visible overlays (i.e., overlays not hidden by `"hideInVanillaSlots"`).
